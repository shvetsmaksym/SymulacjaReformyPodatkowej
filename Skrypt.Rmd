---
title: "Symulacja reformy podatkowej"
author: "Maksym Shvets"
date: "2021-04-27"
output: html_document
---

```{r echo=FALSE}
setwd("C:/Users/Maksim/Desktop/AD/ProjektyPozaStudiami/MF_AnalityczniLiderzy")
```
```{r}
library(data.table)
dochody <- read.csv("dane_dochody.csv", row.names = 1)
dochody <- as.data.table(dochody)
head(dochody)
```

Przydzielamy podatkników do grup podatkowych w zależności od ich dochodu z pracy najemnej.

```{r}
dochody[doch_praca < 10000, prog_doch := 1]
dochody[doch_praca >= 10000 & doch_praca < 70000, prog_doch := 2]
dochody[doch_praca >= 70000, prog_doch := 3]
head(dochody)
```

Liczymy wysokość podatków dla poszczególnych źródeł dochodu

```{r}
dochody[, pod_praca := 0]
dochody[prog_doch == 2, pod_praca := (doch_praca - 10000) * 0.2]
dochody[prog_doch == 3, pod_praca := (70000-10000) * 0.2 + (doch_praca - 70000) * 0.3]
dochody[, pod_dg := 0]
dochody[doch_dg > 0, pod_dg := doch_dg * 0.2]
dochody[, pod_gielda := 0]
dochody[doch_gielda > 0, pod_gielda := doch_gielda * 0.2]
dochody[, podatki_razem:= pod_praca + pod_dg + pod_gielda]
head(dochody)
```

Zatem całkowity dochód Państwa z podatków wyniesie:

```{r}
wplywy.podatki <- sum(dochody$podatki_razem, na.rm = TRUE)
wplywy.podatki
```

Teraz możemy zabrać się za reformę:)

Na początek tworzymy kolumnę z obliczonymi ulgami dla podatników.

```{r}
dochody[, ulga := 0]
dochody[pod_praca >= 1000, ulga := 1000]
dochody[pod_praca < 1000, ulga := pod_praca]
```

Dodajemy kolumne obliczeniową z wysokością podatków z tytułu pracy najmnej po reformie

```{r}
dochody[, pod_praca_akt := pod_praca - ulga]
head(dochody[pod_praca<1000 & pod_praca>0])
```

Obliczamy wpływy do Państwa z tytułu podatków po reformie

```{r}
dochody[, podatki_razem_ref:= pod_praca_akt + pod_dg + pod_gielda]
wplywy.podatki.ref <- sum(dochody$podatki_razem_ref)
wplywy.podatki.ref
```

Teraz obliczamy różnicę między wpływami do reformy i po reformie.

To będzie KOSZT REFORMY.

```{r}
koszt <- wplywy.podatki - wplywy.podatki.ref
koszt
```

Mając koszt reformy nie trudno już policzyć kwotę, którą należy opodatkować 40% podatkiem, żeby wpływy podatkowe pokryły koszt reformy.

40% * x = koszt

```{r}
x <- koszt * (1/0.4)
x
```

Świetnie! Zostało już tylko dopasować próg podatkowy do tej kwoty.

Otwórzmy w tym celu wejściową tabelę raz jeszcze, gdyż nasza zrobiła się już bardzo szeroka i mało czytelna, i dodajmy interesujące nas kolumny obliczeniowe

```{r}
dochody.nieujemne <- read.csv("dane_dochody.csv", row.names = 1)
dochody.nieujemne <- as.data.table(dochody.nieujemne)
```

Zerujemy komórki z wartościami ujemnymi

```{r}
dochody.nieujemne[doch_dg < 0, doch_dg := 0]
dochody.nieujemne[doch_gielda < 0, doch_gielda := 0]
dochody.nieujemne[, razem := doch_praca + doch_dg + doch_gielda]
head(dochody.nieujemne)
```

Ponieważ mamy do przetestowania ogromny zakres prawdopodobnych wysokości dochodów, będących potencjalnymi progami podatkowymi, nie będziemy sprawdzać każdej z nich po kolei w pętli. 

Zastosujemy lecz znacznie wydajniejszy algorytm wyszukiwania binarnego.

```{r}
library("gtools")
func <- function(X) sum(dochody.nieujemne[razem > X, razem - X])
odp = binsearch( func, range = 0:max(dochody.nieujemne$razem), target = x )
odp
```

No i udało się! Zamiast kilkaset tysięcy operacji program uporał się z zadaniem robiąc tylko 19.

Kilka słów wyjaśnień:

1. Funkcja func liczy dochody, które przekroczyły próg podany jako argument. przy czym sumuje tylko część powyżej tego progu (z dochodu 120 tys. z progiem 100 tys. kwota do opodatkowanie wyniesi 20 tys.)

2. Funkcja binsearch podstawia kolejne prawdopodobne progi podatkowe z zakresu od 0 do maksymalnej wysokości dochodu osiągniętego przez co najmniej jednego podatnika aż do momentu kiedy znajdzie odpowiedni próg.

W naszym przypadku wynosi on `r odp$where[1]` jednostek pieniężnych.



